# .github/workflows/naukri-cookie-automation.yml
name: Naukri Cookie-Based Resume Upload

on:
  schedule:
    # 9:30 AM IST = 4:00 AM UTC
    - cron: '30 4 * * *'
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if cookies might be expired'
        required: false
        default: 'false'
        type: boolean
      test_mode:
        description: 'Run in test mode (no actual upload)'
        required: false
        default: 'false'
        type: boolean

jobs:
  upload-resume:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: üõéÔ∏è Checkout repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üì¶ Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install selenium undetected-chromedriver requests python-dotenv
        
    - name: üåê Setup Chrome and ChromeDriver (Improved)
      run: |
        # Update system
        sudo apt-get update
        
        # Install dependencies
        sudo apt-get install -y wget curl unzip xvfb
        
        # Remove any existing Chrome
        sudo apt-get purge -y google-chrome-stable || true
        
        # Install Google Chrome Stable
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Get installed Chrome version
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
        CHROME_MAJOR=$(echo $CHROME_VERSION | cut -d. -f1)
        echo "Chrome version: $CHROME_VERSION"
        echo "Chrome major: $CHROME_MAJOR"
        
        # Install matching ChromeDriver
        # Try Chrome for Testing API first (newer versions)
        CHROMEDRIVER_URL=""
        
        if [ "$CHROME_MAJOR" -ge "115" ]; then
          echo "Using Chrome for Testing API for version $CHROME_MAJOR"
          # Get latest stable version for this major version
          STABLE_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "")
          if [ ! -z "$STABLE_VERSION" ]; then
            CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/${STABLE_VERSION}/linux64/chromedriver-linux64.zip"
          fi
        fi
        
        # Fallback to older API or specific versions
        if [ -z "$CHROMEDRIVER_URL" ]; then
          echo "Falling back to legacy ChromeDriver download..."
          # Try some known working versions
          for VERSION in "114.0.5735.90" "113.0.5672.63" "112.0.5615.49"; do
            if curl -s --head "https://chromedriver.storage.googleapis.com/$VERSION/chromedriver_linux64.zip" | head -n 1 | grep -q "200 OK"; then
              CHROMEDRIVER_URL="https://chromedriver.storage.googleapis.com/$VERSION/chromedriver_linux64.zip"
              echo "Using ChromeDriver version: $VERSION"
              break
            fi
          done
        fi
        
        # Download and install ChromeDriver
        if [ ! -z "$CHROMEDRIVER_URL" ]; then
          wget -N "$CHROMEDRIVER_URL" -O chromedriver.zip
          unzip chromedriver.zip
          
          # Handle different archive structures
          if [ -f "chromedriver-linux64/chromedriver" ]; then
            sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          elif [ -f "chromedriver" ]; then
            sudo mv chromedriver /usr/local/bin/
          else
            echo "ChromeDriver binary not found in expected locations"
            ls -la
            exit 1
          fi
        else
          echo "Could not find suitable ChromeDriver version"
          exit 1
        fi
        
        # Set permissions
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installation
        echo "Verifying Chrome installation:"
        google-chrome --version || echo "Chrome version check failed"
        echo "Verifying ChromeDriver installation:"
        chromedriver --version || echo "ChromeDriver version check failed"
        
        # Test Chrome headless
        echo "Testing Chrome headless mode:"
        timeout 10s google-chrome --headless --disable-gpu --no-sandbox --dump-dom https://www.google.com | head -n 5 || echo "Chrome headless test failed"
        
    - name: üîß Set up display server
      run: |
        # Start virtual display for GUI applications (backup)
        export DISPLAY=:99
        Xvfb :99 -screen 0 1366x768x24 > /dev/null 2>&1 &
        sleep 2
        
    - name: üìÅ Create required directories
      run: |
        mkdir -p cookies
        mkdir -p logs
        mkdir -p /tmp/chrome-profile
        
    - name: üç™ Prepare cookies
      run: |
        if [ ! -z "${{ secrets.NAUKRI_COOKIES_B64 }}" ]; then
          echo "Cookies secret found, decoding..."
          echo "${{ secrets.NAUKRI_COOKIES_B64 }}" | base64 -d > cookies/naukri_cookies.json
          echo "Cookies decoded successfully"
          echo "Cookie file size: $(wc -c < cookies/naukri_cookies.json) bytes"
        else
          echo "‚ùå No cookies found in secrets!"
          exit 1
        fi
        
    - name: üìÑ Verify resume file
      run: |
        if [ -f "resume/Nikhil_Saini_Resume.pdf" ]; then
          echo "‚úÖ Resume file found: $(ls -lh resume/Nikhil_Saini_Resume.pdf)"
        else
          echo "‚ùå Resume file not found!"
          echo "Available files:"
          find . -name "*.pdf" -type f
          exit 1
        fi
        
    - name: üöÄ Run Naukri automation
      env:
        NAUKRI_COOKIES_B64: ${{ secrets.NAUKRI_COOKIES_B64 }}
        RESUME_PATH: './resume/Nikhil_Saini_Resume.pdf'
        MODE: 'automation'
        TEST_MODE: ${{ github.event.inputs.test_mode }}
        DISPLAY: ':99'
        # Chrome specific environment variables
        CHROME_BIN: '/usr/bin/google-chrome'
        CHROMEDRIVER_PATH: '/usr/local/bin/chromedriver'
      run: |
        echo "Starting automation at $(date)"
        echo "Environment check:"
        echo "- Chrome: $(which google-chrome || echo 'not found')"
        echo "- ChromeDriver: $(which chromedriver || echo 'not found')"
        echo "- Display: $DISPLAY"
        echo "- Python: $(python --version)"
        
        # Kill any existing Chrome processes
        pkill -f chrome || true
        sleep 2
        
        # Run the automation with timeout
        timeout 900s python automation/naukri_cookie_uploader.py || {
          echo "Automation timed out or failed"
          exit 1
        }
        
    - name: üßπ Cleanup processes
      if: always()
      run: |
        # Kill Chrome processes
        pkill -f chrome || true
        pkill -f chromedriver || true
        pkill -f Xvfb || true
        sleep 2
        
    - name: üìä Upload logs and screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-artifacts-${{ github.run_number }}
        path: |
          logs/
          *.log
          *.png
        retention-days: 7
        if-no-files-found: ignore
        
    - name: ‚úÖ Success notification
      if: success()
      run: |
        echo "üéâ Resume upload completed successfully!"
        echo "Timestamp: $(date)"
        echo "Next scheduled run: Tomorrow at 9:30 AM IST"
        
    - name: ‚ùå Failure notification
      if: failure()
      run: |
        echo "üö® Automation failed!"
        echo "Possible causes:"
        echo "- Cookies expired (login manually and update NAUKRI_COOKIES_B64 secret)"
        echo "- Naukri website changes"
        echo "- Chrome/ChromeDriver compatibility issues"
        echo "- Network issues"
        echo ""
        echo "Debugging info:"
        echo "- Chrome processes: $(pgrep -f chrome | wc -l)"
        echo "- Available disk space: $(df -h /tmp)"
        echo "- Memory usage: $(free -h)"
        
    - name: üîç Debug information (on failure)
      if: failure()
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== Chrome Version ==="
        google-chrome --version || echo "Chrome not available"
        echo "=== ChromeDriver Version ==="
        chromedriver --version || echo "ChromeDriver not available"
        echo "=== Python Packages ==="
        pip list | grep -E "(selenium|undetected)"
        echo "=== Log Files ==="
        find logs/ -name "*.html" -exec ls -la {} \; 2>/dev/null || echo "No HTML logs"
        find logs/ -name "*.png" -exec ls -la {} \; 2>/dev/null || echo "No screenshots"
        echo "=== Process List ==="
        ps aux | grep -E "(chrome|python)" || echo "No relevant processes"

# Separate workflow for cookie extraction reminder
---
name: Cookie Refresh Reminder

on:
  schedule:
    # Remind to refresh cookies every 25 days
    - cron: '0 9 */25 * *'
  workflow_dispatch:

jobs:
  remind-cookie-refresh:
    runs-on: ubuntu-latest
    steps:
    - name: üîî Cookie refresh reminder
      run: |
        echo "üç™ Time to refresh your Naukri cookies!"
        echo "1. Run the cookie extraction script locally"
        echo "2. Update the NAUKRI_COOKIES_B64 GitHub secret"
        echo "3. Test the automation with manual trigger"
        echo ""
        echo "Cookie refresh is recommended every 25-30 days to maintain login sessions."
